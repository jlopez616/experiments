<html>
  <head>
    <title>OSPAN</title>
    <script src="jspsych-6.0.4/jspsych.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-html-button-operationspan.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-operation-span-recall.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link href="jspsych-6.0.4/css/jspsych_operationspan.css" rel="stylesheet" type="text/css"></link>
    <script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-database.js"></script>

  </head>
  <body></body>
  <script>

        // Initialize Firebase
       
        const firebaseConfig = {
            apiKey: "AIzaSyDPIlw3W-ZEsJoCxKkgDH0eIA-G81BjIwI",
            authDomain: "fraction-ball-2023.firebaseapp.com",
            databaseURL: "https://fraction-ball-2023-default-rtdb.firebaseio.com",
            projectId: "fraction-ball-2023",
            storageBucket: "fraction-ball-2023.appspot.com",
            messagingSenderId: "161791568788",
            appId: "1:161791568788:web:589e0b8dc6a4ab75c93d81"
        }

       /* const firebaseConfig = {
          apiKey: process.env.APIKEY,
          authDomain: process.env.AUTHDOMAIN,
          databaseURL: process.env.DATABASEURL,
          projectId: process.env.PROJECTID,
          storageBucket: process.env.STORAGEBUCKET,
          messagingSenderId: process.env.MESSAGINGSENDERID,
          appId: process.env.APPID,
      }
*/
        firebase.initializeApp(firebaseConfig);


  /*
      This is a web-based operation span working memory test.
      It is modelled after the operation span test described in Oswald et al (2014) [https://link.springer.com/article/10.3758/s13428-014-0543-2].
      However, users can easily customize this test for their own purposes.
      Easily customizable variables have been listed below. For further changes to the test, knowledge of JavaScipt may be required.

      For smooth functioning of the test, make sure all the associated github files within the repository have been downloaded (especially the folder named 'jspsych-6.0.4').
      Results from this test will be automatically downloaded into the downloads folder of your desktop.

      For further details, please refer to the README.
  */

  //----- CUSTOMIZABLE VARIABLES -----------------------------------------

    minSetSize = 3 // starting length of each trial (i.e., min number of letters in a trial) default 4
    maxSetSize = 7 // ending length of each trial (i.e., max number of letters in a trial) default 7
    repSet = 1 // number of times each set size should be repeated default 3
    randomize = false // present different set sizes in random order. if false, set sizes will be presented in ascending order
    file_name = null // file name for data file. if null, a default name consisting of the participant ID and a unique number is chosen.
    local = false // save the data file locally.
                // If this test is being run online (e.g., on MTurk), true will cause the file to be downloaded to the participant's computer.
                // If this test is on a server, and you wish to save the data file to that server, change this to false.
                // If changed to false, ensure that the php file (its in the directory!) and the empty "data" folder has also been appropriately uploaded to the server.
                // Incase of problems, feel free to contact me :)

  //----------------------------------------------------------------------

  var possibleLetters = ["F","H","J","K","L","N","P","Q","R","S","T","V"]

  var setSizes = []    // different set sizes
  for (var i = minSetSize; i<= maxSetSize; i++){
    for (var r = 1; r<= repSet; r++){
      setSizes.push(i)
    }
  }
  //console.log(setSizes)

  var nTrials = setSizes.length // number of trials

  if (randomize){
    setSizes = jsPsych.randomization.sampleWithoutReplacement(setSizes, nTrials)} // shuffle through the set sizes

  var letterMemDemoArray = [3]  // set sizes of initial demo trials (ORIGINALLY 3/4)
  var fullDemoArray = [3]       // set sizes of full demo trials (ORIGINALLY 3/4)
  var nPracticeTrials = letterMemDemoArray.length
  var nfullDemo = fullDemoArray.length
  var nCogLoadDemo = 0

  var setSizes = letterMemDemoArray.concat(fullDemoArray, setSizes)
  var totalTrials = setSizes.length //total number of trials in the entire task (demo + main task)

  var n = 0 //keeps track of number of trials gone by
  var selection = jsPsych.randomization.sampleWithoutReplacement(possibleLetters, setSizes[n])
  var PLV_selection = ['P', 'L', 'V']
  var selection_id = 0 //keeps track of recall items within a test stack

  var nLetterRecalled = 0 // feedback
  var nMathAcc = 0 // feedback

  var cogloadf = function(correct){  // generates math questions
    var possibleOperations = [" + "]
    operation = jsPsych.randomization.sampleWithReplacement(possibleOperations, 1)[0]
    if (operation==" + "){
      num1 = Math.floor(jStat.uniform.sample(1, 10))
      num2 =  Math.floor(jStat.uniform.sample(1, 10))
      ans = num1 + num2
    } else if (operation==" - "){
      num1 = Math.floor(jStat.uniform.sample(1, 10))
      num2 = Math.floor(jStat.uniform.sample(1, num1))
      ans = num1 - num2
    }
    if (!correct){   // generates incorrect answers
      ansDiff = jsPsych.randomization.sampleWithReplacement([1,2],1)[0]
      coinFlip = jsPsych.randomization.sampleWithReplacement([true, false],1)[0]
      if (coinFlip){
        ans += ansDiff
      } else {
        ans -= ansDiff
      }
      if (ans<0){
        ans += 2*ansDiff //ensuring no negative incorrect answers
      }
    }
    return '<div style="font-size:46px;">'+num1+operation+num2+' = '+ans+'<br><br><br><br></div>'
  }

var instructions = {
    type: 'instructions',
    pages: function(){
      pageOne = "<div style='font-size:20px;'><p>Let\'s have fun with a memory game! First we\'ll show you how to play the game.</p></div>"
      pageTwo = '<div style="font-size:20px;">You will click on letters that you see in order. I\’ll do it first!<br><video width="640" height="480" controls><source src="demos/toldemo.mov" type="video/mp4"></video></div>'
      pageThree = '<div style="font-size:20px;">Now you try clicking them! On the next screen, type the letters “P L V”. Are you ready?</div>'

      return [pageOne, pageTwo, pageThree]
    },
    allow_backward: false,
    button_label_next: "Next",
    show_clickable_nav: true
  }

  var instructions2 = {
    type: 'instructions',
    pages: function(){
      pageOne = '<div style="font-size:20px;">Nice job! Now, let\’s see the rules of the game.</div>'
      pageTwo = '<div style="font-size:20px;"><b>This game has two parts:</b><br><br>Game 1: Memorize ALL the letters in order.<br>Game 2: Solve math problems too!<br><br><br>The hardest part? <b>You have to do all of it in your head.</b></div>'
      pageThree = '<div style="font-size:20px;">Ready to practice with letters?<br><br><br>Pay attention, you have to do all of it in your head!</b></div>'
      return [pageOne, pageTwo, pageThree]
    },
    allow_backward: false,
    button_label_next: "Next",
    show_clickable_nav: true
  }

  var instructions3 = {
    type: 'instructions',
    pages: function(){
      pageOne = '<div style="font-size:20px;">Great job with the letters! Ready to add the math game?</div>'
      pageTwo = '<div style="font-size:20px;">Solve the problem as fast as you can and then decide if the answer is correct. Then click on "Correct" or "Incorrect". <br> <img src="demos/ospan_true_false.png" width="320" height="240" ></img></div>'
      pageThree = '<div style="font-size:20px;">Watch how I do it!<br><video width="640" height="480" controls><source src="demos/toldemo.mov" type="video/mp4"></video></div>'
      pageFour = '<div style="font-size:20px;">Ready to practice the math game?<br><br><br>Pay attention, you have to do all of it in your head <b>as fast as you can!</b></div>'

      return [pageOne, pageTwo, pageThree, pageFour]
    },
    allow_backward: false,
    button_label_next: "Next",
    show_clickable_nav: true
  }

  var instructions4 = {
    type: 'instructions',
    pages: function(){
      pageOne = '<div style="font-size:20px;">Great job with the math!<br> Ready to practice the whole game? Now we\'ll put the letter and math games together. <br>1. Remember ALL the letters in order. <br>2. Solve math problems too! <br> Pay attention! You have to do it all in your head!</div>'
      return [pageOne]
    },
    allow_backward: false,
    button_label_next: "Next",
    show_clickable_nav: true,
    on_finish: function(){
      nMathAcc = 0
    }
  }

  var instructions5 = {
    type: 'instructions',
    pages: function(){
      pageOne = '<div style="font-size:20px;">Great job!<br><br>Press "Next" to start main game.<br><br></div>'
      return [pageOne]
    },
    allow_backward: false,
    button_label_next: "Next",
    show_clickable_nav: true
  }

  var cog_load_demo = {
    type: 'html-button-operationspan',
    equation_accuracy: function(){
        nCogLoadDemo +=1
        if (nCogLoadDemo==1){
          eqCorrect = true
        } else if (nCogLoadDemo==2){
          eqCorrect = false
        } else {
          eqCorrect = jsPsych.randomization.sampleWithReplacement([true, false], 1)[0]
        }
        return eqCorrect
      },
    stimulus: function(){
      return cogloadf(eqCorrect)
    },
    choices: ["Correct", "Incorrect"],
    on_finish: function(){
      var acc = jsPsych.data.get().last(1).values()[0].accuracy;
      if (acc==1){
        nMathAcc+=1
      }
    }
  }

var cog_load = {
  type: 'html-button-operationspan',
  equation_accuracy: function(){
      eqCorrect = jsPsych.randomization.sampleWithReplacement([true, false], 1)[0]
      return eqCorrect
  },
  stimulus: function(){
    return cogloadf(eqCorrect)
  },
  trial_duration:6000,
  choices: ["True", "False"],
  on_finish: function(){
    var acc = jsPsych.data.get().last(1).values()[0].accuracy;
    if (acc==1){
      nMathAcc+=1
    }
  }
}

var test_stimuli = {
  type: 'html-keyboard-response',
  stimulus: function(){
    return '<div style="font-size:70px;">'+selection[selection_id]+'<br><br><br><br></div>'
  },
  choices: jsPsych.NO_KEYS,
  trial_duration: 1000,
  on_finish: function(){
    selection_id += 1
  }
}

var PLV_test_stimuli = {
  type: 'html-keyboard-response',
  stimulus: function(){
    return '<div style="font-size:70px;">'+PLV_selection[selection_id]+'<br><br><br><br></div>'
  },
  choices: jsPsych.NO_KEYS,
  trial_duration: 1000,
  on_finish: function(){
    console.log(selection)
    selection_id += 1
  }
}


var end_test_stimuli = {
  type: 'html-keyboard-response',
  stimulus: " ",
  choices: jsPsych.NO_KEYS,
  trial_duration: 0,
  on_finish: function(){
     if (selection_id>=selection.length){
         jsPsych.endCurrentTimeline()
       }
     }
 }

var recall = {
  type: 'operation-span-recall',
  correct_order: function(){
    return selection
  },
  data: function(){
    return {set_size: setSizes[n]}
  },
  on_finish: function(){
    nLetters = setSizes[n]
    nLettersRecalled = jsPsych.data.get().last(1).values()[0].accuracy;
    n+=1
    selection = jsPsych.randomization.sampleWithoutReplacement(possibleLetters, setSizes[n])
    selection_id = 0
  }
}

var PLVrecall = {
  type: 'operation-span-recall',
  correct_order: function(){
    return PLV_selection
  },
  data: function(){
    return {set_size: setSizes[n]}
  },
  on_finish: function(){
    nLetters = setSizes[n]
    nLettersRecalled = jsPsych.data.get().last(1).values()[0].accuracy;
    n+=1
    selection = jsPsych.randomization.sampleWithoutReplacement(possibleLetters, setSizes[n])
    selection_id = 0
  }
}


var feedback = {
    type: 'instructions',
    pages: function(){
      pageOne = "<div style='font-size:20px;'><b>You recalled <font color='blue'>"+nLettersRecalled+" out of "+nLetters+"</font> letters in their correct order.</b><br><br>"
      console.log(n)
      if (n - 1 >nPracticeTrials){
        pageOne+= "You solved <font color='blue'>"+nMathAcc+" out of "+nLetters+"</font> math problems correctly.<br><br></div>"
      }
      return [pageOne]
    },
    allow_backward: false,
    button_label_next: "Next",
    show_clickable_nav: true,
    on_finish: function(){
      nMathAcc = 0
    }
  }

  var feedbackLoad = {
    type: 'html-keyboard-response',
    stimulus: function(){
      var text = ""
      var accuracy = jsPsych.data.get().last(1).values()[0].accuracy
      if (accuracy==1){
        text += '<div style="font-size:35px; color:rgb(0 220 0)"><b>Correct<br><br><br><br></div>'
      } else{
        text += '<div style="font-size:35px; color:rgb(240 0 0)"><b>Incorrect<br><br><br><br></div>'
      }
      //text += '<div style="font-size:30px; color:rgb(0 0 0)"><br><br>New trial starting now.</div>'
      return text
    },
    choices: jsPsych.NO_KEYS,
    trial_duration: 1000
  }

  var conclusion = {
    type: 'html-keyboard-response',
    stimulus: function(){
      return '<div style="font-size:20px;">Great job, thanks for playing!</div>'
  },
    choices: jsPsych.NO_KEYS,
    };
  var p_details = {
    type:"survey-text",
    questions: [{prompt: "Enter Your Student ID Below:"}],
    on_finish:function(){
      partN = jsPsych.data.get().last(1).values()[0].partNum
      partN = partN.replace(/['"]+/g,'')
      console.log(partN)
    }
  }

  function saveData(filename, filedata){
        $.ajax({
              type:'post',
              cache: false,
              url: 'save_data.php', // this is the path to the above PHP script
              data: {filename: filename, filedata: filedata}
        });
  };

  var IDsub = Date.now()
  var dataLog = {
   type: 'html-keyboard-response',
   stimulus: " ",
   trial_duration: 100,
   on_finish: function(data) {
     var data = jsPsych.data.get().filter([{trial_type:'operation-span-recall'}, {trial_type:'html-button-operationspan'}]).json(true);
     console.log(data)
     firebaseRef = firebase.database().ref(partN + "/ospan");
     var promise = new Promise(function(resolve, reject) {
                     resolve(data);
                 })
    promise.then(function (data) {
        firebaseRef.push().set(data, (error) => {
            if (error) {
                for (var i = 0; i < 200; i++) {
                    alert("Thanks for playing!");
                }

                console.log(error);
            } else {
                for (var i = 0; i < 200; i++) {
                    alert("Thanks for playing!");
                }
            }

        });
    }).catch(function (error) {
    alert("Big L")
    console.log(error)
})
    /* if (file_name == null){
       file_name = "WM_operation_span_"+partN+"_"+IDsub.toString()+".csv"}
     else{
       file_name += ".csv"
     }
     if (local){
       data.localSave('csv', file_name )
     } else {
       saveData(file_name, data.csv());
     }*/
  }




      
  }


  var test_stack = {
    timeline: [test_stimuli, cog_load, end_test_stimuli],
    repetitions: 10
  }

  var test_procedure = {
    timeline: [test_stack, recall, feedback],
    repetitions: nTrials - 1
  }

  var PLVDemoStack = {
    timeline: [PLV_test_stimuli, end_test_stimuli],
    repetitions: 3
  }

  var PLV = {
    timeline: [PLVDemoStack, PLVrecall, feedback],
    repetitions: 1
  }

  var lettersDemoStack = {
    timeline: [test_stimuli, end_test_stimuli],
    repetitions: 10
  }

  var lettersDemo = {
    timeline: [lettersDemoStack, recall, feedback],
    repetitions: nPracticeTrials
  }

  var loadDemo = {
    timeline: [cog_load_demo, feedbackLoad],
    repetitions: 5
  }

  var fullDemo = {
    timeline: [test_stack, recall, feedback],
    repetitions: nfullDemo
  }

  timeline = [p_details]
  timeline.push({
    type: 'fullscreen',
    fullscreen_mode: false,
  });

  timeline = timeline.concat([instructions, PLV, instructions2, lettersDemo, instructions3, loadDemo, instructions4, fullDemo, instructions5, test_procedure])
  timeline.push({
  type: 'fullscreen',
  fullscreen_mode: false
  });
  timeline.push(dataLog)
  timeline.push(conclusion)
  jsPsych.init({
      timeline: timeline
  })

</script>
</html>
